# Project Plan: cryptool

## Overview
Build a Go CLI tool `cryptool` to manage crypto data and DB migrations, with configuration sourced from `~/.config/crypto-thing/config.ini`. Initial exchange support: Coinbase Advanced Trade API.

## Requirements
- Read credentials and DB config from `~/.config/crypto-thing/config.ini`.
- DB migrations (PostgreSQL) with commands:
  - `cryptool migrate status`
  - `cryptool migrate up`
  - `cryptool migrate down --step N`
  - `cryptool migrate reset`
- Exchange data fetch for Coinbase:
  - `cryptool exchange coinbase data fetch <start-date> <end-date> <granularity>`: Fetches historical candle data. Validates product ID, reports progress (including rows inserted per batch), and skips already-downloaded data.
  - `cryptool exchange coinbase wallet syncdown`: Lists account balances.
  - `cryptool exchange coinbase data sync-products`: Fetches and stores detailed product information.
  - Date format ISO8601 (e.g., 2024-01-01T00:00:00Z) or YYYY-MM-DD.
  - Granularity: use Coinbase supported values (e.g., 1m, 5m, 15m, 1h, 6h, 1d) mapped to API values.
  - Fetch long ranges efficiently by batching requests (up to 350 candles per request) and iterating over the full range. Deduplicate by timestamp boundary.
  - Respect API limits with client-side RPM rate limiting and retry with exponential backoff on 429/5xx.

## Architecture
- CLI: Cobra with nested commands (`migrate`, `exchange coinbase data fetch`).
- Config: INI parser to load API keys and DB DSN.
- DB: PostgreSQL via `database/sql` with `lib/pq` driver. Migrations via `pressly/goose` embedded SQL migrations.
- Coinbase client: Minimal Advanced Trade client with HMAC auth and `candles` endpoint.
  - Prefer JWT auth via `--coinbase-creds` JSON file, using `go-jose/go-jose.v2` to match official sample.
  - Implements request rate limiting (RPM) and retry with exponential backoff.
  - Candle fetch batching for large ranges is handled within the `data fetch` command, using the `client.GetCandlesOnce` method for each batch.
- Storage: `candles` table keyed by `exchange`, `product_id`, `time` with OHLCV.

## Directory Structure
- `cmd/cryptool/main.go` (entrypoint)
- `cmd/cryptool/root.go` (cobra root command)
- `cmd/cryptool/migrate.go` (migrate subcommands)
- `cmd/cryptool/exchange.go` (exchange parent)
- `cmd/cryptool/coinbase.go` (coinbase parent)
- `cmd/cryptool/coinbase_data.go` (data parent)
- `cmd/cryptool/coinbase_fetch.go` (fetch command)
- `internal/config/config.go` (load INI)
- `internal/db/db.go` (open DB)
- `internal/migrate/migrate.go` (goose wrapper)
- `internal/coinbase/client.go` (auth + candles)
- `internal/coinbase/models.go` (DTOs)
- `internal/ingest/store.go` (insert candles)
- `migrations/0001_init.sql` (initial schema)
- `go.mod`, `go.sum`

## Config File Format (example at ~/.config/crypto-thing/config.ini)
[database]
url = postgres://user:pass@localhost:5432/cryptool?sslmode=disable

[coinbase]
api_key = YOUR_KEY
api_secret = YOUR_SECRET_BASE64
passphrase = OPTIONAL_IF_NEEDED

[app]
products = BTC-USD,ETH-USD

## Milestones
1. Bootstrap CLI + config loader + plan/changelog (current).
2. DB migrations (goose) and initial schema.
3. Coinbase client with candles fetch.
4. Wire command to fetch and store candles.
5. Polishing: logging, retries, validation.
6. Add comprehensive `README.md` with usage instructions.
7. Add `wallet syncdown` command and fix JWT authentication.
8. Refactor `data fetch` command for robustness, adding product ID validation, progress reporting, and gap-filling.
9. Enhance `data fetch` to report rows inserted per batch.
10. Add `sync-products` command to fetch and store detailed product information.

## Notes
- Avoid running commands automatically that modify system state; propose them for approval.
- Ensure all imports at top of files and code compiles.
- Maintenance: Fixed mixed package names (`root` vs `rootroot`) in `cmd/cryptool/root/` and removed invalid `subcmds` import from `cmd/cryptool/root/root.go` to resolve build failures and downstream "missing metadata for import" errors.
